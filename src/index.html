<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>sysinfo-web</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/simplex/bootstrap.min.css" type="text/css" media="screen"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.2.6/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<style type="text/css" media="screen">
h2 {
	font-size: 1.2em;
	text-align: center;
}
div.sort {
	cursor: pointer;
}
hr.global-cpu-divider {
	margin-top: 0;
}
</style>
</head>
<body>
<div class="container">
	<h2 id="global-info"></h2>
	<hr/>
	<canvas id="chart" ref="chart" style="max-height:70vh;min-height:375px;"></canvas>
	<hr/>
</div>
<div id="sysinfo" class="container" v-if="sysinfo">
	<div class="row">
		<div class="col-md-6">
			<div class="panel panel-default">
				<div class="panel-heading">CPU Usage</div>
				<div class="panel-body">
					<div class="row">
						<div class="col-xs-2">Global</div>
						<div class="col-xs-10">
							<div class="progress">
								<div class="progress-bar progress-bar-info" :style="'width: ' + (sysinfo.processor_list[0].cpu_usage * 100) + '%'"></div>
							</div>
						</div>
					</div>
					<hr class="global-cpu-divider">
					<div class="row" v-for="processor in sysinfo.processor_list.slice(1)">
						<div class="col-xs-2">{{ processor.name }}</div>
						<div class="col-xs-10">
							<div class="progress">
								<div class="progress-bar progress-bar-info" :style="'width: ' + (processor.cpu_usage * 100) + '%'"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">Disks</div>
				<div class="panel-body">
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<td>Name</td>
								<td>MP</td>
								<td>FS</td>
								<td>Size</td>
								<td>Used</td>
								<td>Avail</td>
							</tr>
						</thead>
						<tbody>
							<tr v-for="disk in sysinfo.disks">
								<td>{{ disk.name }}</td>
								<td>{{ disk.mount_point }}</td>
								<td>{{ disk.file_system }}</td>
								<td>{{ disk.total_space | readableBytes }}</td>
								<td>{{ disk.total_space - disk.available_space | readableBytes }}</td>
								<td>{{ disk.available_space | readableBytes }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="panel panel-default">
				<div class="panel-heading">Memory Usage</div>
				<div class="panel-body">
					<div class="progress">
						<div class="progress-bar progress-bar-info" :style="'width: ' + (sysinfo.memory[1] * 100 / sysinfo.memory[0]) + '%'"></div>
					</div>
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<td></td>
								<td>Total</td>
								<td>Used</td>
								<td>Free</td>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>Memory</td>
								<td>{{ sysinfo.memory[0] | readableKbytes }}</td>
								<td>{{ sysinfo.memory[1] | readableKbytes }}</td>
								<td>{{ sysinfo.memory[2] | readableKbytes }}</td>
							</tr>
							<tr>
								<td>Swap</td>
								<td>{{ sysinfo.memory[3] | readableKbytes }}</td>
								<td>{{ sysinfo.memory[4] | readableKbytes }}</td>
								<td>{{ sysinfo.memory[5] | readableKbytes }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">Components</div>
				<div class="panel-body">
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<td>Label</td>
								<td>Temperature</td>
								<td>Max</td>
								<td>Critical</td>
							</tr>
						</thead>
						<tbody>
							<tr v-for="component in sysinfo.components_list">
								<td>{{ component.label }}</td>
								<td>{{ component.temperature }} &deg;C</td>
								<td>{{ component.max }} &deg;C</td>
								<td v-if="component.critical && component.critical != ''">{{ component.critical }} &deg;C</td>
								<td v-else></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-xs-12">
			<div class="panel panel-default">
				<div class="panel-heading">Processes</div>
				<div class="panel-body">
					<table class="table table-striped table-hover">
						<thead>
							<tr>
								<th v-for="(c, column) in columns">
									<div v-on:click="sortBy(column)"
										 v-bind:class="{ 'text-info': sortKey == columns[column] && reverse,
														 'text-warning': sortKey == columns[column] && !reverse,
														 'sort': true }">{{ column }}</div>
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="process in sorter">
								<td>{{ process.pid }}</td>
								<td>{{ process.name | truncate }}</td>
								<td>{{ process.uid }}</td>
								<td>{{ process.gid }}</td>
								<td>{{ process.cpu_usage | round }}%</td>
								<td>{{ process.memory | readableKbytes }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
function apply(i) {
	var value = i - 1;
	var v = 0;

	for (var i = 0; i < 8; i++) {
		v = v | (value & 1);
		v = v << 1;
		value = value >> 1;
	}
	v = v >> 1;
	if (v > 255) {
		v = 255;
	}
	return v & 255;
}

function generate_color(index) {
	var n = parseInt(Math.cbrt(index));
	if (index > 3) {
		index += 11;
	}
	index = 1 + index - (n * n * n);

	if (index === 0) {
		return [apply(n), apply(n), apply(n)];
	}
	var p = [n, n, n];
	index -= 1;
	var v = parseInt(index % 3);
	index = parseInt(index / 3);

	if (index < n) {
		p[v] = parseInt(index % n);
		return [apply(p[0]), apply(p[1]), apply(p[2])];
	}
	index -= n;
	p[v] = parseInt(index / n);
	p[parseInt((v + 1) % 3)] = parseInt(index % n);
	return [apply(p[0]), apply(p[1]), apply(p[2])];
}

var PADDING = 5;
var TEN_MINUTES = 60 * 10 / PADDING;

function create_dataset(label, colors) {
	var color = `rgba(${colors[0]},${colors[1]},${colors[2]},1)`;
	var dataset = {
		data: [],
		label: label,
		fill: false,
		lineTension: 0.1,
		backgroundColor: `rgba(${colors[0]},${colors[1]},${colors[2]},0.4)`,
		borderColor: color,
		borderCapStyle: 'butt',
		borderDash: [],
		borderDashOffset: 0.0,
		borderJoinStyle: 'miter',
		pointBorderColor: color,
		pointBackgroundColor: "#fff",
		pointBorderWidth: 1,
		pointHoverRadius: 5,
		pointHoverBackgroundColor: color,
		pointHoverBorderColor: "rgba(220,220,220,1)",
		pointHoverBorderWidth: 2,
		pointRadius: 1,
		pointHitRadius: 10,
	};
	for (var i = 0; i < TEN_MINUTES; i++) {
		dataset.data.push(0);
	}
	return dataset;
}

var chart_values = {labels: [], datasets: []};
for (var i = 0; i < TEN_MINUTES; i++) {
	if (i === 0) {
		chart_values.labels.push(`${i + 1}`);
	} else {
		chart_values.labels.push(`${(i + 1) * PADDING}`);
	}
}
Chart.defaults.scale.ticks.autoSkipPadding = chart_values.labels.length / 15;

var sysinfo = new Vue({
	el: '#sysinfo',
	data: {
		columns: {"PID": "pid", "Name": "name", "UID": "uid", "GID": "gid", "CPU": "cpu_usage", "Memory": "memory"},
		sortKey: "cpu_usage",
		reverse: true,
		sysinfo: null,
		line_chart: new Chart(document.getElementById('chart'), {
			type: 'line',
			data: chart_values,
			options: {
				scale: { reverse: true, ticks: { beginAtZero: true } },
				scales: {
					yAxes: [{ ticks: { max: 100, min: 0 }}]
				}},
		}),
	},
	mounted: function() {
		this.fetchData();
		setInterval(function() {
			this.fetchData();
		}.bind(this), PADDING * 1000);
	},
	methods: {
		fetchData: function() {
			var xhr = new XMLHttpRequest();
			var self = this;
			xhr.open('GET', 'sysinfo.json');
			xhr.onload = function() {
				self.sysinfo = JSON.parse(xhr.responseText);
				var values = [];
				for (proc in self.sysinfo.process_list) {
					values.push(self.sysinfo.process_list[proc]);
				}
				self.sysinfo.process_list = values;
				for (var y = 1; y < self.sysinfo.processor_list.length; y++) {
					if (y > self.line_chart.data.datasets.length) {
						self.line_chart.data.datasets.push(create_dataset(`processor ${y}`, generate_color(y)));
					}
					for (var i = self.line_chart.data.datasets[y - 1].data.length - 1; i > 0; i--) {
						self.line_chart.data.datasets[y - 1].data[i] = self.line_chart.data.datasets[y - 1].data[i - 1];
					}
					self.line_chart.data.datasets[y - 1].data[0] = self.sysinfo.processor_list[y - 1].cpu_usage * 100;
				}
				self.line_chart.update();
				document.getElementById('global-info').textContent = `${self.sysinfo.hostname} â€” ${self.sysinfo.uptime}`;
			}
			xhr.send();
		},
		sortBy: function(sortKey) {
			this.reverse = (this.sortKey == this.columns[sortKey]) ? ! this.reverse : true;
			this.sortKey = this.columns[sortKey];
		},
	},
	computed: {
		sorter: function() {
			if (this.sysinfo == null) {
				return [];
			}
			var self = this;
			var order = self.reverse ? -1 : 1;
			return this.sysinfo.process_list.sort(function(a, b) {
				a = a[self.sortKey];
				b = b[self.sortKey];
				return (a === b ? 0 : a > b ? 1 : -1) * order;
			});
		},
	},
	filters: {
		readableKbytes: function(kbytes) {
			var thresh = 1024;
			if(Math.abs(kbytes) < thresh) {
				return kbytes + ' kiB';
			}
			var units = ['MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
			var u = -1;
			do {
				kbytes /= thresh;
				++u;
			} while(Math.abs(kbytes) >= thresh && u < units.length - 1);
			return kbytes.toFixed(1) + ' ' + units[u];
		},
		readableBytes: function(bytes) {
			var thresh = 1024;
			if(Math.abs(bytes) < thresh) {
				return bytes + ' B';
			}
			var units = ['KiB', 'MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
			var u = -1;
			do {
				bytes /= thresh;
				++u;
			} while(Math.abs(bytes) >= thresh && u < units.length - 1);
			return bytes.toFixed(1) + ' ' + units[u];
		},
		truncate: function(val) {
			return val.substring(0, 100);
		},
		round: function(val) {
			return Math.round(val)
		},
	},
});
</script>
</body>
</html>
